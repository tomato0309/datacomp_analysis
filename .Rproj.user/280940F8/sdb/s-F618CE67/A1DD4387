{
    "collab_server" : "",
    "contents" : "#############################################################################\n#\n#############################################################################\n\n## 環境設定\nplace <- \"~/Documents/データコンペ\"\nquestionare <- paste(place,\"アンケートデータ/CSV\",sep=\"/\")\nweb <- paste(place,\"Web\",sep=\"/\")\npromotion <- paste(place,\"出稿データ\",sep=\"/\")\noutput <- \"~/Documents/データコンペ/analysis_data\"\n\n## ライブラリ読み込み\nif(!require(\"data.table\")){install.packages(\"data.table\")}\nif(!require(\"dplyr\")){install.packages(\"dplyr\")}\nif(!require(\"xlsx\")){install.packages(\"xlsx\")}\nif(!require(\"reshape2\")){install.packages(\"reshape2\")}\noptions(java.parameters = \"-Xmx8000m\")\n\n# メモリ解放\n jgc <- function(){\n  gc()\n  .jcall(\"java/lang/System\", method = \"gc\")\n}\n\n# アンケートデータ\nsetwd(questionare)\nmain_data <- fread(\"メインデータ_2017.csv\")\ntv <- fread(\"テレビ番組別視聴状況_2017.csv\")\nmagazine <-fread(\"雑誌閲読状況_2017.csv\")\n\n# ログデータ\nsetwd(web)\nLog1 <- fread(\"Webアクセスログ（20170128-20170228）.txt\")\nLog2 <- fread(\"Webアクセスログ（20170301-20170401）.txt\")\ncolnames(Log1) <- c(\"サイト\",\"SampleID\",\"date\",\"URL\")\ncolnames(Log2) <- c(\"サイト\",\"SampleID\",\"date\",\"URL\")\n\nfreq1 <- fread(\"Webアクセス頻度（20170128-20170228）.txt\")\nfreq2 <- fread(\"Webアクセス頻度（20170301-20170401）.txt\")\n\n# 出航データ\nsetwd(promotion)\nCM <- read.csv(\"テレビCM出稿データ_2017.csv\",fileEncoding = \"CP932\",stringsAsFactors = F)\nzassi <- read.xlsx(\"雑誌・新聞出稿データ_2017.xlsx\", sheetIndex=1)\nnewspaper <- read.xlsx(\"雑誌・新聞出稿データ_2017.xlsx\", sheetIndex=2)\n\n##\nsetwd(place)\n# メインデータ\n# label_join\nmain_data_masta <- read.xlsx(\"データ定義_2017.xlsx\",sheetIndex=3,colIndex=c(1,2),startRow = 2)\nmain_data_masta <- main_data_masta[-1,]\nmain_data_masta$変数名 <- as.character(main_data_masta$変数名)\nM <- melt(main_data,id.vars = \"SampleID\")\nM$variable <- as.character(M$variable)\nM_join <- inner_join(M,main_data_masta,by=c(\"variable\"=\"変数名\"))\nlabel_join <- \n  M_join %>%\n  dplyr::select(-variable) %>%\n  dcast(SampleID ~ ラベル,value.var=\"value\") %>%\n  data.frame()\nM <- NULL;M_join <- NULL\n\n# CMデータ\n# CM_useとwatch_use\ntv_masta <- read.xlsx(\"データ定義_2017.xlsx\",sheetIndex=1,colIndex=c(5:12),startRow = 2)\ntv_masta<-tv_masta[-1,]\ntv_masta$番組ID <- as.character(tv_masta$番組ID)\nCM$番組ID <- as.character(CM$番組ID)\nCM$ID <- gsub(\"TVWatch.\",\"\",CM$番組ID)\nCM_data<-inner_join(tv_masta,CM,by=c(\"番組ID\"=\"ID\"))\nCM_use <- CM_data %>% dplyr::select(-ID,-番組ID.y)\ntv_melt <- melt(tv,id.vars = \"SampleID\") #%>% filter(value==1) \ntv_melt$variable <- as.character(tv_melt$variable)\ntv_melt$番組ID <- gsub(\"TVWatch.\",\"\",tv_melt$variable)\nwatch_use <- tv_melt %>% select(-variable)\n\n# 雑誌データ\n# magazine_use\nmagazine_masta <- read.xlsx(\"データ定義_2017.xlsx\",sheetIndex=2,colIndex=c(1,2,5,6),startRow = 2)\nmagazine_masta <- magazine_masta[-1,]\nmagazine_masta$変数 <- as.character(magazine_masta$変数)\nmagazine_melt <-melt(magazine,id.vars = \"SampleID\")\nmagazine_melt$variable <- as.character(magazine_melt$variable)\nmagazine_data <-inner_join(magazine_melt,magazine_masta,by=c(\"variable\"=\"変数\"))\nmagazine_melt <- NULL;\nzassi$variable <- paste(\"MZ\",zassi$雑誌コード,sep=\".\")\nzassi$雑誌名 <- as.character(zassi$雑誌名)\nmagazine_data$雑誌名 <- as.character(magazine_data$雑誌名)\nmagazine_use<-inner_join(magazine_data,zassi,by=c(\"variable\"=\"variable\",\"雑誌名\"=\"雑誌名\"))\n\n# 新聞データ\n# newspaper_use\nnewspaper_variable <- colnames(label_join)[grep(\"新聞\",colnames(label_join))]\nnews_melt<-melt(label_join[,c(\"SampleID\",newspaper_variable)],id.vars = \"SampleID\")\nnames_variable <- data.frame(variable = unique(news_melt$variable))\nnames_variable$variable <- as.character(names_variable$variable)\nnames<-as.character(gsub(\"新聞_\",\"\",gsub(\".02.03月\",\"\",names_variable$variable)))\nnames_variable$names <-as.character(gsub(\"新聞_\",\"\",gsub(\".02.03月\",\"\",names_variable$variable)))\n#news_paper_name <- gsub(\"新聞_会社などで閲読.02.03月.\",\"\",newspaper_variable[1:27])\n\nfor(i in 1:length(names)){\n  names_variable[i,\"形態\"]<- strsplit(names[i], \".\",fixed = T)[[1]][1]\n  names_variable[i,\"新聞\"]<- strsplit(names[i], \".\",fixed = T)[[1]][2]\n}\nnewspaper_use <- inner_join(news_melt,names_variable[,c(\"variable\",\"形態\",\"新聞\")],by=c(\"variable\"))\n\n\n# Webアクセス\n# web_dataとLog1とLog2\nweb_masta <- read.xlsx(\"データ定義_2017.xlsx\",sheetIndex=4,colIndex=c(1,2,3),startRow = 2)\nweb_masta <- web_masta[-1,]\nweb_masta$変数 <- as.character(web_masta$変数)\nweb_masta$variable <- gsub(\"@\",\"site\",web_masta$変数)\nfreq1_melt <- melt(freq1,id.vars = \"SampleID\")\nfreq2_melt <- melt(freq2,id.vars = \"SampleID\")\nfreq <- rbind(freq1_melt,freq2_melt)\nweb_data<-inner_join(freq,web_masta,by=c(\"variable\"))\n\n# カテゴリの紐付け\nsetwd(\"~/Documents/データコンペ/01データ受け渡し\")\nmasta <-read.csv(\"PI→CAT.csv\",header=F)\nmasta <- masta[,c(1:5)]\n\nmasta$V4 <- gsub(\"（購入意向）\",\"\",masta$V4)\nmasta$id <- substring(masta$V1,7,12)\n\ncategory <- unique(masta$V4)\nfor(i in category){\n  sub <- subset(masta,V4==i,c(\"id\",\"V4\",\"V2\"))\n  ids <- sub$id\n  \n  for(k in ids){\n    <- as.character(main_data_masta$ラベル[grep(k,main_data_masta$変数名)])\n    \n    \n  }\n  \n  \n}\n  \n\n\n\n\n## データ出力\nsetwd(output)\nwrite.csv(label_join,\"メインデータ分析用.csv\")\nwrite.csv(CM_use,\"CMマスタデータ.csv\",fileEncoding = \"CP932\")\nwrite.csv(watch_use,\"CM閲覧データ.csv\",fileEncoding = \"CP932\")\nwrite.csv(magazine_use,\"雑誌データ.csv\",fileEncoding = \"CP932\")\nwrite.csv(newspaper_use,\"新聞データ.csv\",fileEncoding = \"CP932\")\nwrite.csv(web_data,\"ウェブデータ.csv\",fileEncoding = \"CP932\")\n\n\n\n\n\n## 変数名区分\n# オブジェクトをlabel_joinに指定すると任意のデータが得られる\ntrain_variable <- colnames(label_join)[grep(\"利用路線\",colnames(label_join))]\nvalue_variable <- colnames(label_join)[grep(\"消費価値観\",colnames(label_join))]\ndurable_variable <- colnames(label_join)[grep(\"耐久消費財\",colnames(label_join))]\nnewspaper_variable <- colnames(label_join)[grep(\"新聞\",colnames(label_join))]\nhobby_variable <- colnames(label_join)[grep(\"趣味\",colnames(label_join))]\nsymptom_variable <- colnames(label_join)[grep(\"気になる症状\",colnames(label_join))]\nstation_variable <- colnames(label_join)[grep(\"駅利用\",colnames(label_join))]\nchannel_variable <- colnames(label_join)[grep(\"チャネル利用頻度\",colnames(label_join))]\ncgm_variable <- colnames(label_join)[grep(\"CGM利用頻度\",colnames(label_join))]\nchannelfreq_variable <- colnames(label_join)[grep(\"1ヶ月以内利用頻度\",colnames(label_join))]\nradio_variable <- colnames(label_join)[grep(\"ラジオ\",colnames(label_join))]\npc_variable <- colnames(label_join)[grep(\"パソコン\",colnames(label_join))]\nmobile_variable <- colnames(label_join)[grep(\"携帯電話\",colnames(label_join))]\nPI_variable <- colnames(label_join)[grep(\"購入意向.\",colnames(label_join))]\nPS_variable <- colnames(label_join)[grep(\"購入実態.\",colnames(label_join))]\nPC_variable <- colnames(label_join)[grep(\"購入回数.\",colnames(label_join))]\ndemografic_variable <- \n  c(\"性別\",\n    \"年齢\",\n    \"未既婚\",\n    \"子供有無\",\n    \"子供人数\",\n    \"第１子の年齢\",\n    \"第２子の年齢\",\n    \"第３子の年齢\",\n    \"第４子の年齢\",\n    \"末子の年齢\",\n    \"家族構成\",\n    \"居住地\",\n    \"職業\",\n    \"あなたの現在のお住まいは.以下のどれにあたりますか.なお.親などの持ち家に同居している場合も.持ち家.としてお考えください..ひとつだけ.\",\n    \"BS視聴可能有無.あなたのご家庭では.BS放送.例.NHK.BS1など.を見ることができますか.\",\n    \"世帯保有金融資産\",\n    \"世帯年収\")\n\n\n\n\n###########################################################################\n## 利用例\n###\n\n## メインデータ\n# 変数名_variable\n# train,value,train,value,durable,newspaper,hobby,symptom,\n# station,channel,cgm,channelfreq,radio,pc,mobile,PI,PS,PC,demografic,\n# head(label_join[,PC_variable])\n\n\n\n\n\n## 洋服\nclose_data <-\n  main_data %>% \n  dplyr::select(\n    SampleID\n    ,SEX_CD\n    ,AGE\n    ,MARRIAGE\n    ,CHILD_CD\n    ,PREF_CD\n    ,PI_01_753506 # earth music & ecology\n    ,PS_01_753506\n    ,PI_02_753506\n    ,PS_02_753506\n    ,PI_01_753507 # GU\n    ,PS_01_753507\n    ,PI_02_753507\n    ,PS_02_753507\n    ,PI_01_753508 # しまむら\n    ,PS_01_753508\n    ,PI_02_753508\n    ,PS_02_753508\n    ,PI_01_753509 # gloval work\n    ,PS_01_753509\n    ,PI_02_753509\n    ,PS_02_753509\n    ,PI_01_753510 # ユニクロ\n    ,PS_01_753510\n    ,PI_02_753510\n    ,PS_02_753510\n  )\n\n\n\n",
    "created" : 1503126474269.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2422913759",
    "id" : "A1DD4387",
    "lastKnownWriteTime" : 1504537341,
    "last_content_update" : 1504537341724,
    "path" : "~/Documents/データコンペ/データ読み込み.R",
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}