{
    "collab_server" : "",
    "contents" : "#############################################################################\n#  モデリング用データセット作成\n#############################################################################\n\n## \ninput <- \"~/Documents/データコンペ/analysis_data\"\nplace <- \"~/Documents/データコンペ\"\nweb <- paste(place,\"Web\",sep=\"/\")\nplace <- \"~/Documents/データコンペ\"\nquestionare <- paste(place,\"アンケートデータ/CSV\",sep=\"/\")\n\n## ライブラリ読み込み\nif(!require(\"data.table\")){install.packages(\"data.table\")}\nif(!require(\"dplyr\")){install.packages(\"dplyr\")}\nif(!require(\"xlsx\")){install.packages(\"xlsx\")}\nif(!require(\"reshape2\")){install.packages(\"reshape2\")}\nif(!require(\"foreach\")){install.packages(\"foreach\")}\nif(!require(\"tcltk\")){install.packages(\"tcltk\")}\nif(!require(\"readr\")){install.packages(\"readr\")}\nif(!require(\"stringr\")){install.packages(\"stringr\")}\noptions(java.parameters = \"-Xmx8000m\")\n\n## \nsetwd(questionare)\nall_data <- data.frame(fread(\"メインデータ_2017.csv\"))\nm_data<-melt(all_data,id.vars = \"SampleID\")\n\nsetwd(input)\nmain_data <- read_csv(\"メインデータ分析用.csv\",locale = locale(encoding = \"cp932\"))\n\n## 変数名区分\n# オブジェクトをmain_dataに指定すると任意のデータが得られる\ntrain_variable <- colnames(main_data)[grep(\"利用路線\",colnames(main_data))]\nvalue_variable <- colnames(main_data)[grep(\"消費価値観\",colnames(main_data))]\ndurable_variable <- colnames(main_data)[grep(\"耐久消費財\",colnames(main_data))]\nnewspaper_variable <- colnames(main_data)[grep(\"新聞\",colnames(main_data))]\nhobby_variable <- colnames(main_data)[grep(\"趣味\",colnames(main_data))]\nsymptom_variable <- colnames(main_data)[grep(\"気になる症状\",colnames(main_data))]\nstation_variable <- colnames(main_data)[grep(\"駅利用\",colnames(main_data))]\nchannel_variable <- colnames(main_data)[grep(\"チャネル利用頻度\",colnames(main_data))]\ncgm_variable <- colnames(main_data)[grep(\"CGM利用頻度\",colnames(main_data))]\nchannelfreq_variable <- colnames(main_data)[grep(\"1ヶ月以内利用頻度\",colnames(main_data))]\nradio_variable <- colnames(main_data)[grep(\"ラジオ\",colnames(main_data))]\npc_variable <- colnames(main_data)[grep(\"パソコン\",colnames(main_data))]\nmobile_variable <- colnames(main_data)[grep(\"携帯電話\",colnames(main_data))]\nPI_variable <- colnames(main_data)[grep(\"購入意向.\",colnames(main_data))]\nPS_variable <- colnames(main_data)[grep(\"購入実態.\",colnames(main_data))]\nPC_variable <- colnames(main_data)[grep(\"購入回数.\",colnames(main_data))]\ndemografic_variable <- \n  c(\"性別\",\n    \"年齢\",\n    \"未既婚\",\n    \"子供有無\",\n    \"子供人数\",\n    \"第１子の年齢\",\n    \"第２子の年齢\",\n    \"第３子の年齢\",\n    \"第４子の年齢\",\n    \"末子の年齢\",\n    \"家族構成\",\n    \"居住地\",\n    \"職業\",\n    \"あなたの現在のお住まいは.以下のどれにあたりますか.なお.親などの持ち家に同居している場合も.持ち家.としてお考えください..ひとつだけ.\",\n    \"BS視聴可能有無.あなたのご家庭では.BS放送.例.NHK.BS1など.を見ることができますか.\",\n    \"世帯保有金融資産\",\n    \"世帯年収\")\n\n## \ndemo_data<-data.frame(main_data[,c(\"SampleID\",demografic_variable)])\n\n\n## カテゴリ情報の紐付け\nsetwd(input)\ncate<-read.xlsx(\"カテゴリーPS割り付け.xlsx\",sheetIndex = 1)\ncate$product_id <- substring(cate$製品PS,7,16)\ncate$製品PS <- as.character(cate$製品PS)\nm_data$variable <- as.character(m_data$variable)\ncate$research_date <- gsub(\"）\",\"\",gsub(\"（\",\"\",apply(data.frame(cate[,\"製品名\"]),1,FUN = function(x){substring(x,(regexpr(\"（0\",x)[1]),nchar(x))}),fixed = T),fixed = T)\nres <- inner_join(m_data,cate,by=c(\"variable\"=\"製品PS\"))\n\n## 文字列処理\nres$製品名 <- as.character(res$製品名)\nres$product_name <- apply(data.frame(res[,\"製品名\"]),1,FUN = function(x){substring(x,1,(regexpr(\"_\",x)[1])-1)})\n\n## マスタ作成\nbrand_category_masta <-\n  res %>% \n  dplyr::select(\n     product_id\n    , product_name\n    , カテゴリー名\n    ) %>% \n  unique() %>% \n  data.frame()\n\n\n## 態度と購入をブランド別消費者別に加工する\n#beer <- c(\"\")\n#brand_category_masta[brand_category_masta$カテゴリー名 == \"ドリンク剤（購入意向）\",\"カテゴリ名\"]\n#brand_id <- unique(brand_category_masta$product_id)\n\n## ひとまずビールに限定する\nbeer <-\n  brand_category_masta %>% \n  filter(カテゴリー名==\"缶やビン入りのビール（発泡酒や第三のビールを除く）（購入回数）\") %>% \n  data.frame()\nbrand_id <- unique(beer$product_id)\n\n#brand_id <- brand_category_masta %>% filter(カテゴリー名==beer) %>% select(カテゴリー名) %>% unique()\ncst_id <- unique(res$SampleID)[1:500]\nresult_data <- data.frame()\nprogress.bar <- paste(rep(\"-\", length(cst_id)), collapse=\"\")\n\nfor(i in cst_id){ # 消費者別\n  \n  cat(progress.bar, i, \"\\n\")          # プログレスバーの表示\n  progress.bar <- substring(progress.bar, 2) # プログレスバーを進める\n  \n  for(k in brand_id){ # ブランド別\n    \n    sample_per <-\n      m_data %>% \n      filter(SampleID == i) %>%\n      filter(str_count(variable,k)>=1) %>% \n      mutate(variable_name = \n        ifelse(str_count(variable,\"PI_01\")>=1,\"第1期購入意向\",\n        ifelse(str_count(variable,\"PS_01\")>=1,\"第1期購入実態\",\n        ifelse(str_count(variable,\"PI_02\")>=1,\"第2期購入意向\",\n        ifelse(str_count(variable,\"PS_02\")>=1,\"第2期購入実態\",\"他\"))))\n      ) %>% \n      dcast(SampleID ~ variable_name,value.var = \"value\") %>%\n      mutate(product_id = k) %>%\n      inner_join(brand_category_masta,by=c(\"product_id\")) %>% \n      data.frame()\n    \n    result_data <- rbind(result_data,sample_per)\n    \n  } # ブランド別\n} # 消費者別\n\n\n### CM要因(番組とブランドの紐付け)\ncm_category <- read.xlsx(\"CMカテゴリー割り付け済み.xlsx\",sheetIndex = 1,stringsAsFactors=FALSE)\ncm_category<-\n  cm_category %>% \n  filter(is.na(番組ID)==F) %>%\n  filter(is.na(広告主)==F) %>%\n  data.frame()\ncm_category[is.na(cm_category)] <- 0\ncm_category$番組ID <- gsub(\"TVWatch.\",\"\",cm_category$番組ID)\n\nsetwd(place)\ntv_masta <- read.xlsx(\"データ定義_2017.xlsx\",sheetIndex=1,colIndex=c(5:12),startRow = 2)\ntv_masta<-tv_masta[-1,]\ntv_masta$番組ID <- as.character(tv_masta$番組ID)\ncm_data <- inner_join(tv_masta,cm_category)\n\n\n## CM要因(SampleIDと番組の紐付け)\nsetwd(questionare)\ntv <- data.frame(fread(\"テレビ番組別視聴状況_2017.csv\"))\nm_tv <- melt(tv,id.vars = \"SampleID\")\nm_tv$variable <- gsub(\"TVWatch.\",\"\",m_tv$variable)\n\n## CM視聴と消費者の紐付け\ncm_watch <-\n  result_data %>% \n  select(SampleID) %>% \n  inner_join(m_tv,by=c(\"SampleID\")) %>%\n  inner_join(cm_data,by=c(\"variable\"=\"番組ID\")) %>% \n  filter(缶やビン入りのビール.発泡酒や第三のビールを除く..購入回数. != 0) %>% \n  filter(アイテム名 != \"本搾りチューハイ グレープフルーツ/レモン\") %>%\n  select(SampleID,variable,value,放送日,開始時,開始分,終了時,終了分,放送局,広告主,アイテム名,秒数) %>% \n  data.frame() \n\n## \ntvcm_name = as.character(unique(cm_watch$アイテム名))\nques_name = data.frame(ques_name = as.character(unique(result_data$product_name)))\nbeer_name <- c(\"ヱビスビール\"\n                ,\"ヱビスビール\"\n                ,\"アサヒ スーパードライ\"\n                ,\"サッポロ 生ビール黒ラベル\"\n                ,\"キリン 一番搾り生ビール\"\n                ,\"なし\"\n                ,\"アサヒ スーパードライ\"\n                ,\"ヱビスビール\"\n                ,\"サントリー ザ・プレミアム・モルツ\"\n                ,\"アサヒ スーパードライ\"\n              )\nmasta <- data.frame(cbind(tvcm_name,beer_name))\n\nmasta$tvcm_name <- as.character(masta$tvcm_name)\nmasta$beer_name <- as.character(masta$beer_name)\nques_name$ques_name <- as.character(ques_name$ques_name)\n\nfull_masta <- dplyr::full_join(masta,ques_name,by=c(\"beer_name\" =\"ques_name\")) %>% \n  filter(is.na(tvcm_name)==F | is.na(beer_name)==F) %>%\n  data.frame()\nfull_masta[is.na(full_masta)] <- \"なし\"\ncolnames(full_masta)[2] <- \"research_name\"\n\njoin_data <- left_join(cm_watch,full_masta,by=c(\"アイテム名\"=\"tvcm_name\"))\n\nsetwd(place)\nmain_data_masta <- read.xlsx(\"データ定義_2017.xlsx\",sheetIndex=3,colIndex=c(1,2),startRow = 2)\nmain_data_masta <- main_data_masta[-1,]\nmain_data_masta$変数名 <- as.character(main_data_masta$変数名)\n\n## \nbrand_id_data <- data.frame()  \n  \nfor(k in brand_id){\n  \n  main_data_masta$flg <- ifelse(str_count(main_data_masta$変数名,k) >= 1,1,0)\n  main_data_masta_limit<- main_data_masta %>% filter(flg == 1) %>% select(ラベル) %>% data.frame()\n  \n  main_data_masta_limit$date <- gsub(\"）\",\"\",gsub(\"（\",\"\",apply(data.frame(main_data_masta_limit[,\"ラベル\"]),1,FUN = function(x){substring(x,(regexpr(\"（0\",x)[1]),nchar(x))}),fixed = T),fixed = T)\n  main_data_masta_limit$product_id <- k\n  t1 <- unique(main_data_masta_limit$date)[1]\n  t2 <- unique(main_data_masta_limit$date)[2]\n  product_id <- unique(main_data_masta_limit$product_id)\n  id_data <- data.frame(cbind(product_id,t1,t2))\n  \n  brand_id_data <- rbind(brand_id_data,id_data)\n}\n\n## \n\n\n\n\n\n\n\n\n\n\n\n\nM <- melt(main_data,id.vars = \"SampleID\")\nM$variable <- as.character(M$variable)\n\n\nres %>%\nfilter(カテゴリー名 == \"缶やビン入りのビール（発泡酒や第三のビールを除く）（購入回数）\") %>%\ngroup_by(\n  product_name\n  ,research_date\n  ) %>% \nsummarise(N = n()) %>%\ndata.frame()\n\n\n\n\n\n\n\n\n\n",
    "created" : 1509248191373.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "930040716",
    "id" : "90E99DAF",
    "lastKnownWriteTime" : 1509459552,
    "last_content_update" : 1509459552285,
    "path" : "~/Documents/データコンペ/データコンペ集計用データセット.R",
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled3"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}